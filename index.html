<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Upload File</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{font-family:sans-serif;margin:0;padding:16px;background:#f9fafb;}
  .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,0.08);max-width:500px;margin:20px auto;}
  input,button{padding:10px;width:100%;margin:8px 0;border-radius:8px;border:1px solid #d1d5db;}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer;}
  #result{margin-top:12px;font-size:14px;}
</style>
</head>
<body>
<div class="card">
  <h2>Secure Upload</h2>
  <input id="publicKey" type="text" placeholder="Enter your Public Key" required />
  <input id="customName" type="text" placeholder="Optional: Custom file name" />
  <input id="fileInput" type="file" />
  <button id="uploadBtn">Upload</button>
  <p id="status"></p>
  <div id="result"></div>
</div>

<script>
  const SUPABASE_URL = "https://fjkkdcnzozlejdwyquvh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqa2tkY256b3psZWpkd3lxdXZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjgxNjcsImV4cCI6MjA3MjEwNDE2N30.buL6jOmdgkNmAP6LYVPydvTaMhmeCejRRMGdVjWFAYw";
  const BUCKET = "secure-files";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const uploadBtn = document.getElementById("uploadBtn");
  const statusEl = document.getElementById("status");
  const resultEl = document.getElementById("result");

  uploadBtn.onclick = async () => {
    const publicKey = document.getElementById("publicKey").value.trim();
    const customName = document.getElementById("customName").value.trim();
    const fileEl = document.getElementById("fileInput");

    if (!publicKey) {
      alert("Public Key is required");
      return;
    }
    if (!fileEl.files.length) {
      alert("Please select a file");
      return;
    }

    const file = fileEl.files[0];
    const finalName = customName ? customName : file.name;
    const path = `${publicKey}/${Date.now()}_${sanitize(finalName)}`;

    statusEl.textContent = "Uploading...";

    const { error } = await sb.storage.from(BUCKET).upload(path, file, {
      contentType: file.type || "application/octet-stream",
      upsert: false
    });

    if (error) {
      statusEl.textContent = "";
      alert("Upload failed: " + error.message);
      return;
    }

    statusEl.textContent = "Upload complete.";

    // Generate signed URL (valid for 24 hours)
    const { data: linkData, error: linkError } = await sb.storage.from(BUCKET)
      .createSignedUrl(path, 60 * 60 * 24);
    if (linkError) {
      resultEl.innerHTML = "File uploaded, but could not create download link.";
      return;
    }

    resultEl.innerHTML = `
      <p><strong>File Path:</strong> ${path}</p>
      <p><a href="${linkData.signedUrl}" target="_blank">Download (24h link)</a></p>
    `;

    // OPTIONAL: Send data to an automation tool (Zapier/Make) via webhook
    // fetch("https://hooks.zapier.com/hooks/catch/...", {
    //   method: "POST",
    //   headers: {"Content-Type":"application/json"},
    //   body: JSON.stringify({publicKey, path, link: linkData.signedUrl})
    // });
  };

  function sanitize(name){
    return name.replace(/[^\w.\-]+/g,"_");
  }
</script>
</body>
</html>
